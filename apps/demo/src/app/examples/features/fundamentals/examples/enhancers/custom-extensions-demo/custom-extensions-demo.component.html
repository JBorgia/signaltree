<div class="custom-extensions-demo">
  <header class="demo-header">
    <h1>ğŸ”§ Custom Markers & Enhancers</h1>
    <p class="subtitle">
      Learn how to extend SignalTree with your own markers and enhancers. These
      examples show <strong>why</strong> markers and enhancers are powerful -
      not just how to make them.
    </p>
  </header>

  <!-- Overview Section -->
  <section class="overview-section">
    <div class="concept-cards">
      <div class="concept-card marker-card">
        <div class="card-icon">ğŸ·ï¸</div>
        <h3>Markers</h3>
        <p>
          Rich APIs from simple declarations. Define <code>counter(0)</code> and
          get <code>increment()</code>, <code>decrement()</code>,
          <code>reset()</code> for free.
        </p>
        <ul>
          <li>State + behavior bundled together</li>
          <li>Type-safe, auto-materialized</li>
          <li>Two patterns: standalone or in-tree</li>
        </ul>
      </div>

      <div class="concept-card enhancer-card">
        <div class="card-icon">âš¡</div>
        <h3>Enhancers</h3>
        <p>
          Cross-cutting concerns that <strong>interact with tree state</strong>.
          Add undo/redo, freeze mutations, auto-save - capabilities that span
          your entire tree.
        </p>
        <ul>
          <li>Actually work with tree state</li>
          <li>Composable via <code>.with()</code></li>
          <li>More than just wrapped services</li>
        </ul>
      </div>
    </div>

    <!-- Two Patterns Callout -->
    <div class="patterns-callout">
      <h4>ğŸ“Œ Two Patterns for Custom Signals</h4>
      <div class="patterns-grid">
        <div class="pattern-box">
          <strong>Pattern 1: Standalone Factories</strong>
          <p>Create and use immediately. No registration needed.</p>
          <code>const likes = createCounter(0);</code>
        </div>
        <div class="pattern-box">
          <strong>Pattern 2: Markers in Tree State</strong>
          <p>Embed in SignalTree. Register processor first!</p>
          <code>signalTree(&#123; views: counter(0) &#125;)</code>
        </div>
      </div>
    </div>
  </section>

  <!-- Live Demo Section -->
  <section class="demo-section">
    <h2>ğŸ“ Live Demo</h2>

    <div class="demo-grid">
      <!-- Counter Marker Demo -->
      <div class="demo-panel counter-panel">
        <h3>ğŸ¯ Pattern 1: Standalone Factories</h3>
        <p class="panel-desc">
          <code>createCounter(initial, step)</code> - No registration needed
        </p>

        <div class="counter-demo">
          <div class="counter-item">
            <span class="counter-label">Likes (step: 1)</span>
            <div class="counter-controls">
              <button class="btn small" (click)="likes.decrement()">âˆ’</button>
              <span class="counter-value">{{ likes() }}</span>
              <button class="btn small" (click)="likes.increment()">+</button>
              <button class="btn tiny" (click)="likes.reset()">Reset</button>
            </div>
          </div>

          <div class="counter-item">
            <span class="counter-label">Quantity (step: 5)</span>
            <div class="counter-controls">
              <button class="btn small" (click)="quantity.decrement()">
                âˆ’5
              </button>
              <span class="counter-value">{{ quantity() }}</span>
              <button class="btn small" (click)="quantity.increment()">
                +5
              </button>
              <button class="btn tiny" (click)="quantity.reset()">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Marker in Tree Demo -->
      <div class="demo-panel marker-tree-panel">
        <h3>ğŸŒ³ Pattern 2: Markers in Tree</h3>
        <p class="panel-desc">
          <code>signalTree(&#123; views: counter(0) &#125;)</code> - State lives
          in tree
        </p>

        <div class="counter-demo">
          <div class="counter-item">
            <span class="counter-label">Page Views (in tree)</span>
            <div class="counter-controls">
              <button class="btn small" (click)="pageViews.decrement()">
                âˆ’
              </button>
              <span class="counter-value">{{ pageViews() }}</span>
              <button class="btn small" (click)="pageViews.increment()">
                +
              </button>
              <button class="btn tiny" (click)="pageViews.reset()">
                Reset
              </button>
            </div>
          </div>

          <div class="counter-item">
            <span class="counter-label"
              >Favorites: {{ favoriteIds.count() }}</span
            >
            <div class="counter-controls">
              @for (product of treeWithMarkers.$.products(); track product.id) {
              <button
                class="btn tiny"
                [class.active]="favoriteIds.isSelected(product.id)"
                (click)="favoriteIds.toggle(product.id)"
              >
                {{ favoriteIds.isSelected(product.id) ? 'â˜…' : 'â˜†' }}
                {{ product.name }}
              </button>
              }
            </div>
          </div>
        </div>

        <p class="hint">
          âš ï¸ <code>registerMarkerProcessor()</code> was called before
          <code>signalTree()</code>
        </p>
      </div>

      <!-- Selection Marker Demo -->
      <div class="demo-panel selection-panel">
        <h3>âœ… selection() Marker</h3>
        <p class="panel-desc">
          Multi-select state from <code>selection&lt;number&gt;()</code>
        </p>

        <div class="task-list">
          @for (task of store.$.tasks(); track task.id) {
          <div
            class="task-item"
            [class.selected]="selectedTaskIds.isSelected(task.id)"
            [class.completed]="task.completed"
            (click)="toggleTask(task.id)"
            (keydown.enter)="toggleTask(task.id)"
            tabindex="0"
          >
            <span class="task-checkbox">
              {{ selectedTaskIds.isSelected(task.id) ? 'â˜‘' : 'â˜' }}
            </span>
            <span class="task-title">{{ task.title }}</span>
            @if (task.completed) {
            <span class="completed-badge">âœ“ Done</span>
            }
          </div>
          }
        </div>

        <div class="selection-info">
          <span>{{ selectedTaskIds.count() }} selected</span>
          <div class="selection-actions">
            <button class="btn tiny" (click)="selectAllTasks()">
              Select All
            </button>
            <button
              class="btn tiny"
              (click)="clearSelection()"
              [disabled]="!selectedTaskIds.hasSelection()"
            >
              Clear
            </button>
            <button
              class="btn tiny primary"
              (click)="completeSelected()"
              [disabled]="!selectedTaskIds.hasSelection()"
            >
              Complete Selected
            </button>
          </div>
        </div>
      </div>

      <!-- Undo/Redo Enhancer Demo -->
      <div class="demo-panel undo-panel">
        <h3>â†©ï¸ withUndo() Enhancer</h3>
        <p class="panel-desc">
          Snapshots and restores <strong>actual tree state</strong>
        </p>

        <div class="form-group">
          <label for="userName">User Name</label>
          <input
            id="userName"
            type="text"
            [value]="store.$.userName()"
            (input)="updateUserName($event)"
            placeholder="Type to change..."
          />
        </div>

        <div class="undo-controls">
          <button
            class="btn"
            (click)="undo()"
            [disabled]="!canUndo()"
            title="Undo last change"
          >
            â†©ï¸ Undo
          </button>
          <button
            class="btn"
            (click)="redo()"
            [disabled]="!canRedo()"
            title="Redo"
          >
            â†ªï¸ Redo
          </button>
          <span class="history-info">{{ historyLength() }} checkpoints</span>
        </div>

        <p class="hint">
          Try changing the name, selecting tasks, or clicking counters - then
          undo!
        </p>
      </div>

      <!-- Freeze Enhancer Demo -->
      <div class="demo-panel freeze-panel" [class.frozen]="isFrozen()">
        <h3>ğŸ”’ withFreeze() Enhancer</h3>
        <p class="panel-desc">Prevents all mutations while frozen</p>

        <div class="freeze-controls">
          <button
            class="btn"
            [class.active]="isFrozen()"
            (click)="isFrozen() ? unfreeze() : freeze()"
          >
            {{ isFrozen() ? 'ğŸ”“ Unfreeze' : 'ğŸ”’ Freeze' }}
          </button>
          <span class="freeze-status" [class.frozen]="isFrozen()">
            {{
              isFrozen()
                ? 'State is FROZEN - mutations blocked!'
                : 'State is mutable'
            }}
          </span>
        </div>

        @if (isFrozen()) {
        <p class="freeze-warning">
          âš ï¸ Try clicking counters or changing text - nothing will happen! Check
          the console for warnings.
        </p>
        }
      </div>
    </div>
  </section>

  <!-- Code Examples Section -->
  <section class="code-section">
    <h2>ğŸ“š Implementation Guide</h2>

    <div class="code-examples-container">
      <div class="code-example">
        <h4>ğŸ¯ counter() Marker - Hello World</h4>
        <p class="code-desc">
          The simplest marker - state + methods from a single declaration:
        </p>
        <pre class="code-block" #counterCode></pre>
      </div>

      <div class="code-example">
        <h4>âœ… selection() Marker - Practical Value</h4>
        <p class="code-desc">
          A marker that manages multi-select state - immediately useful:
        </p>
        <pre class="code-block" #selectionCode></pre>
      </div>

      <div class="code-example">
        <h4>â†©ï¸ withUndo() Enhancer - Tree Interaction</h4>
        <p class="code-desc">
          An enhancer that <strong>actually works with tree state</strong>:
        </p>
        <pre class="code-block" #undoCode></pre>
      </div>

      <div class="code-example">
        <h4>ğŸ”’ withFreeze() Enhancer - Simple Power</h4>
        <p class="code-desc">
          Prevent mutations during async operations or submissions:
        </p>
        <pre class="code-block" #freezeCode></pre>
      </div>

      <div class="code-example">
        <h4>ğŸš€ Complete Usage</h4>
        <p class="code-desc">
          Combining custom markers and enhancers in a real application:
        </p>
        <pre class="code-block" #usageCode></pre>
      </div>
    </div>
  </section>

  <!-- Why Better Section -->
  <section class="why-section">
    <h2>ğŸ’¡ Why These Are Better</h2>

    <div class="comparison-grid">
      <div class="comparison-card">
        <h4>Markers vs Services</h4>
        <table class="comparison-table">
          <tr>
            <th>Plain Service</th>
            <th>Custom Marker</th>
          </tr>
          <tr>
            <td>Separate from state</td>
            <td>Part of state definition</td>
          </tr>
          <tr>
            <td>Manual wiring</td>
            <td>Auto-materialized</td>
          </tr>
          <tr>
            <td>No type inference</td>
            <td>Full TypeScript support</td>
          </tr>
          <tr>
            <td>
              <code>counterService.increment()</code>
            </td>
            <td>
              <code>store.$.likes.increment()</code>
            </td>
          </tr>
        </table>
      </div>

      <div class="comparison-card">
        <h4>Enhancers vs Wrapper Services</h4>
        <table class="comparison-table">
          <tr>
            <th>Wrapper Service</th>
            <th>Custom Enhancer</th>
          </tr>
          <tr>
            <td>Doesn't see tree state</td>
            <td>Snapshots/restores state</td>
          </tr>
          <tr>
            <td>Manual integration</td>
            <td><code>.with()</code> composition</td>
          </tr>
          <tr>
            <td>Can't intercept mutations</td>
            <td>Can freeze, validate, log</td>
          </tr>
          <tr>
            <td>Separate API</td>
            <td>Unified tree API</td>
          </tr>
        </table>
      </div>
    </div>
  </section>

  <!-- Best Practices Section -->
  <section class="best-practices-section">
    <h2>âœ… Best Practices</h2>

    <div class="practices-grid">
      <div class="practice-card">
        <h4>Markers</h4>
        <ul>
          <li>Use <code>Symbol()</code> for unique identification</li>
          <li>Keep materializers pure - no side effects</li>
          <li>Register processors once at app startup</li>
          <li>Provide <code>reset()</code> for easy state clearing</li>
          <li>Use computed signals for derived state</li>
        </ul>
      </div>

      <div class="practice-card">
        <h4>Enhancers</h4>
        <ul>
          <li>Return <code>tree & YourMethods</code> for TypeScript</li>
          <li>Use <code>Object.assign()</code> to preserve tree identity</li>
          <li>Actually interact with tree state when possible</li>
          <li>Consider cleanup in <code>destroy()</code> if needed</li>
          <li>Add <code>/*&#64;__PURE__*/</code> for tree-shaking</li>
        </ul>
      </div>
    </div>
  </section>
</div>
