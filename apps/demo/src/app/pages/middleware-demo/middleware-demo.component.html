<div class="container">
  <h1>ğŸ”— SignalTree Middleware Demo</h1>

  <div class="explanation-card">
    <h2>ğŸ“– What is Middleware?</h2>
    <p class="intro-text">
      <strong>Middleware</strong> functions intercept state changes <em>before</em> or <em>after</em> they happen. 
      Use them to add logging, validation, persistence, undo/redo without cluttering your core logic.
    </p>

    <div class="how-it-works">
      <h3>ğŸ¯ How It Works</h3>
      <ol class="instruction-list">
        <li><strong>Toggle middleware</strong> on/off to see how they intercept actions</li>
        <li><strong>Add/modify todos</strong> to trigger middleware execution</li>
        <li><strong>Watch the execution chain</strong> to see the order middleware runs</li>
        <li><strong>Check the logs</strong> to see what each middleware does</li>
      </ol>
    </div>

    <div class="key-features">
      <h3>âœ¨ Middleware Examples</h3>
      <div class="feature-tags">
        <span class="feature-tag">ğŸ” Logging</span>
        <span class="feature-tag">âœ… Validation</span>
        <span class="feature-tag">ğŸ’¾ Persistence</span>
        <span class="feature-tag">â†¶ Undo/Redo</span>
      </div>
    </div>
  </div>

  <div class="demo-grid">
    <div class="card middleware-card">
      <h2>âš™ï¸ Middleware Controls</h2>
      <p class="card-description">Toggle middleware on/off</p>

      <div class="middleware-toggles">
        <label class="toggle-item" [class.active]="enableLogging">
          <div class="toggle-header">
            <input type="checkbox" [(ngModel)]="enableLogging" />
            <span class="toggle-label">ğŸ” Logging</span>
            <span class="toggle-badge" [class.on]="enableLogging">
              {{ enableLogging ? 'ON' : 'OFF' }}
            </span>
          </div>
          <p class="toggle-description">Logs every action</p>
        </label>

        <label class="toggle-item" [class.active]="enableValidation">
          <div class="toggle-header">
            <input type="checkbox" [(ngModel)]="enableValidation" />
            <span class="toggle-label">âœ… Validation</span>
            <span class="toggle-badge" [class.on]="enableValidation">
              {{ enableValidation ? 'ON' : 'OFF' }}
            </span>
          </div>
          <p class="toggle-description">Prevents invalid data</p>
        </label>

        <label class="toggle-item" [class.active]="enablePersistence">
          <div class="toggle-header">
            <input type="checkbox" [(ngModel)]="enablePersistence" />
            <span class="toggle-label">ğŸ’¾ Persistence</span>
            <span class="toggle-badge" [class.on]="enablePersistence">
              {{ enablePersistence ? 'ON' : 'OFF' }}
            </span>
          </div>
          <p class="toggle-description">Auto-saves to localStorage</p>
        </label>

        <label class="toggle-item" [class.active]="enableUndo">
          <div class="toggle-header">
            <input type="checkbox" [(ngModel)]="enableUndo" />
            <span class="toggle-label">â†¶ Undo/Redo</span>
            <span class="toggle-badge" [class.on]="enableUndo">
              {{ enableUndo ? 'ON' : 'OFF' }}
            </span>
          </div>
          <p class="toggle-description">Tracks state history</p>
        </label>
      </div>

      <div class="execution-chain">
        <h3>ğŸ“Š Execution Chain</h3>
        <p class="chain-description">{{ getActiveMiddlewareCount() }} middleware active</p>
        
        <div class="chain-visualization">
          <div class="chain-step start">
            <div class="step-label">â–¶ï¸ Action Start</div>
          </div>
          <div *ngIf="enableLogging" class="chain-step middleware">
            <div class="step-label">ğŸ” Logging (before)</div>
          </div>
          <div *ngIf="enableValidation" class="chain-step middleware">
            <div class="step-label">âœ… Validation</div>
          </div>
          <div class="chain-step core">
            <div class="step-label">âš¡ Core Action</div>
          </div>
          <div *ngIf="enablePersistence" class="chain-step middleware">
            <div class="step-label">ğŸ’¾ Persistence</div>
          </div>
          <div *ngIf="enableUndo" class="chain-step middleware">
            <div class="step-label">â†¶ Undo Stack</div>
          </div>
          <div *ngIf="enableLogging" class="chain-step middleware">
            <div class="step-label">ğŸ” Logging (after)</div>
          </div>
          <div class="chain-step end">
            <div class="step-label">âœ“ Complete</div>
          </div>
        </div>
      </div>

      <div *ngIf="enableUndo" class="undo-controls">
        <h3>â†¶ Undo/Redo</h3>
        <div class="button-group">
          <button class="btn-secondary" (click)="handleUndo()" [disabled]="!canUndo()">â†¶ Undo</button>
          <button class="btn-secondary" (click)="handleRedo()" [disabled]="!canRedo()">â†· Redo</button>
        </div>
        <p class="undo-stats">Undo: {{ getUndoCount() }} | Redo: {{ getRedoCount() }}</p>
      </div>
    </div>

    <div class="card todos-card">
      <h2>âœ… Todo List</h2>
      <p class="card-description">Trigger middleware by modifying todos</p>

      <div class="add-todo-section">
        <div class="input-group">
          <input type="text" class="form-input" [(ngModel)]="newTodoTitle" placeholder="Enter todo title..." (keyup.enter)="addTodo()" />
          <button class="btn-primary" (click)="addTodo()" [disabled]="!newTodoTitle.trim()">â• Add</button>
        </div>
        <button class="btn-success btn-sm full-width" (click)="addRandomTodos()">ğŸ² Add 3 Random</button>
      </div>

      <div class="filter-section">
        <div class="button-group">
          <button class="btn-filter" [class.active]="filter() === 'all'" (click)="setFilter('all')">All ({{ allTodos().length }})</button>
          <button class="btn-filter" [class.active]="filter() === 'active'" (click)="setFilter('active')">Active ({{ activeTodos().length }})</button>
          <button class="btn-filter" [class.active]="filter() === 'completed'" (click)="setFilter('completed')">Completed ({{ completedTodos().length }})</button>
        </div>
      </div>

      <div class="todos-list">
        <div *ngIf="filteredTodos().length === 0" class="empty-state">
          <p>ğŸ“ No todos</p>
        </div>
        <div *ngFor="let todo of filteredTodos()" class="todo-item" [class.completed]="todo.completed">
          <input type="checkbox" [checked]="todo.completed" (change)="toggleTodo(todo.id)" />
          <span class="todo-title">{{ todo.title }}</span>
          <button class="btn-danger btn-xs" (click)="deleteTodo(todo.id)">ğŸ—‘ï¸</button>
        </div>
      </div>

      <div class="quick-actions">
        <button class="btn-warning btn-sm" (click)="clearCompleted()" [disabled]="completedTodos().length === 0">ğŸ§¹ Clear Completed</button>
        <button class="btn-danger btn-sm" (click)="clearAllTodos()" [disabled]="allTodos().length === 0">ğŸ—‘ï¸ Clear All</button>
      </div>
    </div>
  </div>

  <div class="section-card logs-card">
    <div class="logs-header">
      <h2>ğŸ“‹ Middleware Logs</h2>
      <button class="btn-secondary btn-sm" (click)="clearLogs()">ğŸ§¹ Clear</button>
    </div>
    <p class="card-description">Real-time middleware activity</p>

    <div *ngIf="middlewareLogs().length === 0" class="empty-logs">
      <p>ğŸ“ No logs yet</p>
      <p class="empty-hint">Enable logging and perform actions</p>
    </div>

    <div *ngIf="middlewareLogs().length > 0" class="logs-list">
      <div *ngFor="let log of middlewareLogs()" class="log-entry" [class]="log.type">
        <div class="log-icon">
          <span *ngIf="log.type === 'before'">â–¶ï¸</span>
          <span *ngIf="log.type === 'after'">âœ“</span>
          <span *ngIf="log.type === 'error'">âŒ</span>
        </div>
        <div class="log-content">
          <div class="log-header">
            <span class="log-action">{{ log.action }}</span>
            <span class="log-time">{{ formatTime(log.timestamp) }}</span>
          </div>
          <div class="log-message">{{ log.data?.['message'] || log.error }}</div>
          <div *ngIf="log.duration" class="log-duration">â±ï¸ {{ log.duration.toFixed(2) }}ms</div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="enablePersistence" class="section-card persistence-card">
    <h2>ğŸ’¾ Persistence Status</h2>
    <p class="card-description">Auto-saved to localStorage</p>
    <div class="persistence-info">
      <div class="info-item">
        <span class="info-label">Last Saved:</span>
        <span>{{ getLastSavedTime() }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Items:</span>
        <span>{{ allTodos().length }} todos</span>
      </div>
    </div>
    <button class="btn-warning btn-sm" (click)="clearStorage()">ğŸ—‘ï¸ Clear Storage</button>
  </div>
</div>
