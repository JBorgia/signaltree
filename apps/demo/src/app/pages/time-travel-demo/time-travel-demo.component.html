<div class="container">
  <h1>SignalTree Time Travel Demo</h1>

  <div class="demo-grid">
    <!-- Controls -->
    <div class="card">
      <h2>State Controls</h2>

      <div class="controls-section">
        <!-- Counter -->
        <div>
          <label for="counter" class="label">Counter: {{ counter() }}</label>
          <div class="button-group">
            <button (click)="increment()" class="btn-primary">+1</button>
            <button (click)="decrement()" class="btn-danger">-1</button>
          </div>
        </div>

        <!-- Message -->
        <div>
          <label for="message" class="label">Message:</label>
          <input
            id="message"
            type="text"
            [(ngModel)]="message"
            class="form-input"
          />
        </div>

        <!-- Todo -->
        <div>
          <label for="newTodo" class="label">Add Todo:</label>
          <div class="input-group">
            <input
              id="newTodo"
              type="text"
              [(ngModel)]="newTodoText"
              placeholder="Enter todo..."
              class="form-input"
            />
            <button
              (click)="addTodo()"
              [disabled]="!newTodoText.trim()"
              class="btn-success"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Time Travel Controls -->
    <div class="card">
      <h2>Time Travel</h2>

      <div class="time-travel-section">
        <!-- Navigation -->
        <div class="navigation-buttons">
          <button (click)="undo()" [disabled]="!canUndo()" class="btn-warning">
            ‚Ü∂ Undo
          </button>
          <button (click)="redo()" [disabled]="!canRedo()" class="btn-purple">
            ‚Ü∑ Redo
          </button>
        </div>

        <!-- Keyboard Shortcuts Info -->
        <div class="shortcuts-info">
          <div class="shortcuts-header">‚å®Ô∏è Keyboard Shortcuts</div>
          <div class="shortcuts-list">
            <div>‚Üê ‚Üí : Navigate history</div>
            <div>Ctrl/Cmd+Z : Undo</div>
            <div>Ctrl+Y / Cmd+Shift+Z : Redo</div>
          </div>
        </div>

        <button (click)="resetHistory()" class="btn-danger full-width">
          Reset History
        </button>

        <!-- History Search -->
        <div class="search-panel">
          <div class="search-header">üîç Search History</div>
          <div class="search-input-group">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              placeholder="Filter by action..."
              class="search-input"
            />
            <button
              *ngIf="hasSearchResults()"
              (click)="clearSearch()"
              class="btn-secondary btn-sm"
            >
              ‚úï
            </button>
          </div>
          <div class="search-results" *ngIf="hasSearchResults()">
            {{ getFilteredHistory().length }} result(s) found
          </div>
        </div>

        <!-- Bookmarks -->
        <div class="bookmarks-panel">
          <div class="bookmarks-header">
            <span>üîñ Bookmarks</span>
            <button
              (click)="clearAllBookmarks()"
              [disabled]="bookmarks.size === 0"
              class="btn-warning btn-xs"
            >
              Clear All
            </button>
          </div>
          <div class="bookmarks-count">{{ bookmarks.size }} bookmark(s)</div>
        </div>

        <!-- History Info -->
        <div class="history-info">
          <p><strong>Current Index:</strong> {{ getCurrentIndex() }}</p>
          <p><strong>History Length:</strong> {{ getHistory().length }}</p>
        </div>

        <!-- Timeline Visualization -->
        <div class="timeline-section">
          <h3>Timeline:</h3>
          <div class="timeline-container">
            <!-- Timeline bar -->
            <div class="timeline-nodes">
              <div
                *ngFor="let entry of getHistory(); let i = index"
                class="timeline-node-wrapper"
              >
                <button
                  (click)="jumpTo(i)"
                  [class]="getTimelineNodeClass(i)"
                  class="timeline-node"
                  [title]="'#' + i + ': ' + (entry.action || 'Initial')"
                  type="button"
                >
                  <span class="node-label">{{ i }}</span>
                  <!-- Bookmark indicator -->
                  <span
                    *ngIf="isBookmarked(i)"
                    class="bookmark-indicator"
                    title="Bookmarked"
                  >
                    üîñ
                  </span>
                </button>
                <!-- Connector line -->
                <div
                  *ngIf="i < getHistory().length - 1"
                  class="timeline-connector"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- History List -->
        <div class="history-list">
          <h3>
            History Log:
            <span class="filter-indicator" *ngIf="hasSearchResults()">
              (filtered)
            </span>
          </h3>
          <div class="history-items">
            <div
              *ngFor="let entry of getFilteredHistory(); let i = index"
              class="history-item"
            >
              <button
                (click)="jumpTo(i)"
                (keydown.enter)="jumpTo(i)"
                (keydown.space)="jumpTo(i)"
                [class]="getHistoryItemClass(i)"
                class="history-item-button"
                type="button"
              >
                <span class="history-index">{{ i }}:</span>
                {{ entry.action || 'Initial' }}
                <span class="history-timestamp"
                  >({{ entry.timestamp | date : 'short' }})</span
                >
              </button>
              <button
                (click)="toggleBookmark(i)"
                [class]="
                  isBookmarked(i) ? 'bookmark-active' : 'bookmark-inactive'
                "
                class="bookmark-button"
                title="Toggle bookmark"
                type="button"
              >
                üîñ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Current State Display with Diff -->
  <div class="state-display-grid">
    <!-- Current State -->
    <div class="card">
      <h2>Current State</h2>
      <div class="state-content">
        <div>
          <h3>Counter:</h3>
          <p class="counter-value">{{ counter() }}</p>
        </div>
        <div>
          <h3>Message:</h3>
          <p class="message-value">{{ message() || '(empty)' }}</p>
        </div>
        <div>
          <h3>Todos ({{ todos().length }}):</h3>
          <ul class="todos-list">
            <li
              *ngFor="let todo of todos()"
              [class.completed]="todo.completed"
              class="todo-item"
            >
              <button
                (click)="toggleTodo(todo.id)"
                (keydown.enter)="toggleTodo(todo.id)"
                (keydown.space)="toggleTodo(todo.id)"
                class="todo-button"
                type="button"
              >
                {{ todo.completed ? '‚úì' : '‚óã' }} {{ todo.text }}
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- State Diff Viewer -->
    <div class="card">
      <h2>
        State Diff
        <span class="subtitle">(vs previous)</span>
      </h2>
      <div *ngIf="getStateDiff() as diff" class="diff-content">
        <!-- Counter diff -->
        <div
          *ngIf="diff.counter"
          class="diff-item"
          [class.added]="diff.counter.type === 'added'"
          [class.modified]="diff.counter.type === 'modified'"
        >
          <div class="diff-label">Counter:</div>
          <div class="diff-values">
            <span
              *ngIf="diff.counter.oldValue !== undefined"
              class="old-value"
              >{{ diff.counter.oldValue }}</span
            >
            <span class="new-value">{{ diff.counter.newValue }}</span>
          </div>
        </div>

        <!-- Message diff -->
        <div
          *ngIf="diff.message"
          class="diff-item"
          [class.added]="diff.message.type === 'added'"
          [class.modified]="diff.message.type === 'modified'"
        >
          <div class="diff-label">Message:</div>
          <div class="diff-values">
            <div *ngIf="diff.message.oldValue" class="old-value">
              "{{ diff.message.oldValue }}"
            </div>
            <div class="new-value">"{{ diff.message.newValue }}"</div>
          </div>
        </div>

        <!-- Todos diff -->
        <div
          *ngIf="diff.todos"
          class="diff-item"
          [class.added]="diff.todos.type === 'added'"
          [class.modified]="diff.todos.type === 'modified'"
        >
          <div class="diff-label">Todos: {{ diff.todos.description }}</div>
          <div class="diff-count">
            Count: {{ diff.todos.oldCount }} ‚Üí {{ diff.todos.newCount }}
          </div>
        </div>

        <!-- No changes -->
        <div
          *ngIf="!diff.counter && !diff.message && !diff.todos"
          class="no-changes"
        >
          No changes detected
        </div>
      </div>
    </div>
  </div>
</div>
