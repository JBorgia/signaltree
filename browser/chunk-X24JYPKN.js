import{ra as g}from"./chunk-YYEXL5C7.js";import{a as c,b as P}from"./chunk-A3ECCK3J.js";var y=class{value=null;children=new Map},m=class{root=new y;pathCache=new Map;stats={hits:0,misses:0,sets:0,cleanups:0};enableInstrumentation=!1;instrumentation={incrementalUpdates:0,fullRebuilds:0,nodesTouched:0,deletions:0,rebuildDurationNs:0};set(e,n){let t=this.pathToString(e),i=new WeakRef(n),r=this.root;for(let s of e){let a=String(s);r.children.has(a)||r.children.set(a,new y);let o=r.children.get(a);if(!o)throw new Error(`Failed to get node for key: ${a}`);r=o}r.value=i,this.pathCache.set(t,i),this.stats.sets++}get(e){let n=this.pathToString(e),t=this.pathCache.get(n);if(t){let r=t.deref();if(r)return this.stats.hits++,r;this.pathCache.delete(n),this.stats.cleanups++}let i=this.root;for(let r of e){let s=String(r);if(i=i.children.get(s),!i)return this.stats.misses++,null}if(i.value){let r=i.value.deref();if(r)return this.pathCache.set(n,i.value),this.stats.hits++,r;i.value=null,this.stats.cleanups++}return this.stats.misses++,null}has(e){return this.get(e)!==null}getByPrefix(e){let n=new Map,t=this.root;for(let i of e){let r=String(i);if(t=t.children.get(r),!t)return n}return this.collectDescendants(t,[],n),n}delete(e){let n=this.pathToString(e);this.pathCache.delete(n);let t=this.root,i=[t];for(let s of e){let a=String(s);if(t=t.children.get(a),!t)return!1;i.push(t)}let r=t.value!==null;t.value=null;for(let s=i.length-1;s>0;s--){let a=i[s];if(a.value===null&&a.children.size===0){let o=i[s-1],l=e[s-1];o.children.delete(String(l))}else break}return r}clear(){this.root=new y,this.pathCache.clear(),this.enableInstrumentation&&this.instrumentation.fullRebuilds++}getStats(){let e=this.stats.hits+this.stats.misses,n=e>0?this.stats.hits/e:0;return P(c({},this.stats),{hitRate:n,cacheSize:this.pathCache.size})}buildFromTree(e,n=[]){if(e){if(g(e)){this.set(n,e);return}if(typeof e=="object")for(let[t,i]of Object.entries(e))this.buildFromTree(i,[...n,t])}}pathToString(e){return e.join(".")}collectDescendants(e,n,t){if(e.value){let i=e.value.deref();i&&t.set(this.pathToString(n),i)}for(let[i,r]of e.children)this.collectDescendants(r,[...n,i],t)}deleteSubtree(e){if(e.length===0){this.clear();return}let n=this.root,t=[n];for(let a of e){if(n=n.children.get(String(a)),!n)return;t.push(n)}let i=[],r=(a,o)=>{a.value&&i.push(this.pathToString(o));for(let[l,u]of a.children)r(u,[...o,l])};r(t[t.length-1],e);for(let a of i)this.pathCache.delete(a);t[t.length-2].children.delete(String(e[e.length-1])),this.enableInstrumentation&&(this.instrumentation.deletions+=i.length||1)}incrementalUpdate(e,n){let t=this.enableInstrumentation?performance.now():0;if(!n.length)return;if(n.length>2e3||n.includes("")){this.clear(),this.buildFromTree(e),this.enableInstrumentation&&(this.instrumentation.rebuildDurationNs+=(performance.now()-t)*1e6);return}let r=[...n].sort((a,o)=>a.length-o.length),s=[];for(let a of r)s.some(o=>a!==o&&a.startsWith(o+"."))||s.push(a);for(let a of s){let o=a===""?[]:a.split("."),l=e;for(let u of o){if(!l||typeof l!="object"){l=void 0;break}l=l[u]}if(l==null){this.deleteSubtree(o);continue}if(g(l)){this.set(o,l),this.enableInstrumentation&&this.instrumentation.nodesTouched++;continue}typeof l=="object"?(this.deleteSubtree(o),this.buildFromTree(l,o),this.enableInstrumentation&&this.instrumentation.nodesTouched++):this.deleteSubtree(o)}this.enableInstrumentation&&(this.instrumentation.incrementalUpdates++,this.instrumentation.rebuildDurationNs+=(performance.now()-t)*1e6)}setInstrumentation(e){this.enableInstrumentation=e}getInstrumentation(e=!1){let n=c({},this.instrumentation);return e&&(this.instrumentation.incrementalUpdates=0,this.instrumentation.fullRebuilds=0,this.instrumentation.nodesTouched=0,this.instrumentation.deletions=0,this.instrumentation.rebuildDurationNs=0),n}};var b=class{defaultOptions={maxDepth:100,detectDeletions:!1,ignoreArrayOrder:!1,equalityFn:(e,n)=>e===n,keyValidator:void 0,instrumentation:!1};diff(e,n,t={}){let i=c(c({},this.defaultOptions),t),r=[],s=new WeakSet,a={elementComparisons:0,prefixFastPathHits:0,wholeArrayReplaceHits:0,traversals:0,suffixFastPathHits:0,segmentSkips:0,samplesTaken:0};return this.traverse(e,n,[],r,s,i,0,a),{changes:r,hasChanges:r.length>0,instrumentation:i.instrumentation?a:void 0}}traverse(e,n,t,i,r,s,a,o){if(s.instrumentation&&o.traversals++,a>s.maxDepth||e===n)return;if(typeof n!="object"||n===null){s.equalityFn(e,n)||i.push({type:e===void 0?"add":"update",path:[...t],value:n,oldValue:e});return}if(r.has(n))return;if(r.add(n),Array.isArray(n)){this.diffArrays(e,n,t,i,r,s,a,o);return}if(!e||typeof e!="object"||Array.isArray(e)){i.push({type:"replace",path:[...t],value:n,oldValue:e});return}let l=e,u=n;for(let p in u)if(Object.prototype.hasOwnProperty.call(u,p)){if(s.keyValidator&&!s.keyValidator(p))continue;this.traverse(l[p],u[p],[...t,p],i,r,s,a+1,o)}if(s.detectDeletions)for(let p in l)Object.prototype.hasOwnProperty.call(l,p)&&!(p in u)&&i.push({type:"delete",path:[...t,p],oldValue:l[p]})}diffArrays(e,n,t,i,r,s,a,o){if(!Array.isArray(e)){i.push({type:"replace",path:[...t],value:n,oldValue:e});return}s.ignoreArrayOrder?this.diffArraysUnordered(e,n,t,i,s):this.diffArraysOrdered(e,n,t,i,r,s,a,o)}diffArraysOrdered(e,n,t,i,r,s,a,o){if(e===n)return;if(e.length===n.length){let f=!0;for(let h=0;h<e.length;h++)if(s.instrumentation&&o.elementComparisons++,e[h]!==n[h]){f=!1;break}if(f)return}let l=e.length,u=n.length,p=Math.min(l,u);if(p>0){let f=!0;for(let h=0;h<p;h++)if(s.instrumentation&&o.elementComparisons++,e[h]!==n[h]){f=!1;break}if(f&&l!==u){if(s.instrumentation&&o.prefixFastPathHits++,u>l)for(let h=l;h<u;h++)i.push({type:"add",path:[...t,h],value:n[h]});else if(l>u&&s.detectDeletions)for(let h=u;h<l;h++)i.push({type:"delete",path:[...t,h],oldValue:e[h]});return}}let k=1024,v=.4;if(l>=k&&u>=k&&l===u){let f=0;for(let h=0;h<l;h++)if(s.instrumentation&&o.elementComparisons++,e[h]!==n[h]&&(f++,f/l>v)){i.push({type:"replace",path:[...t],value:n,oldValue:e}),s.instrumentation&&o.wholeArrayReplaceHits++;return}}let w=Math.max(l,u);for(let f=0;f<w;f++)f>=n.length?s.detectDeletions&&i.push({type:"delete",path:[...t,f],oldValue:e[f]}):f>=e.length?i.push({type:"add",path:[...t,f],value:n[f]}):this.traverse(e[f],n[f],[...t,f],i,r,s,a+1,o)}diffArraysUnordered(e,n,t,i,r){let s=new Set(e.map(o=>this.stringify(o))),a=new Set(n.map(o=>this.stringify(o)));n.forEach((o,l)=>{let u=this.stringify(o);s.has(u)||i.push({type:"add",path:[...t,l],value:o})}),r.detectDeletions&&e.forEach((o,l)=>{let u=this.stringify(o);a.has(u)||i.push({type:"delete",path:[...t,l],oldValue:o})})}stringify(e){try{return JSON.stringify(e)}catch{return String(e)}}};var T=class{pathIndex;diffEngine;constructor(e){this.pathIndex=new m,this.diffEngine=new b,this.pathIndex.buildFromTree(e)}update(e,n,t={}){let i=performance.now(),r={};t.maxDepth!==void 0&&(r.maxDepth=t.maxDepth),t.ignoreArrayOrder!==void 0&&(r.ignoreArrayOrder=t.ignoreArrayOrder),t.equalityFn!==void 0&&(r.equalityFn=t.equalityFn);let s=this.diffEngine.diff(e,n,r);if(s.changes.length===0)return{changed:!1,duration:performance.now()-i,changedPaths:[]};let a=this.createPatches(s.changes),o=this.sortPatches(a),l=t.batch?this.batchApplyPatches(e,o,t.batchSize):this.applyPatches(e,o);return{changed:!0,duration:performance.now()-i,changedPaths:l.appliedPaths,stats:{totalPaths:s.changes.length,optimizedPaths:a.length,batchedUpdates:l.batchCount}}}rebuildIndex(e){this.pathIndex.clear(),this.pathIndex.buildFromTree(e)}getIndexStats(){return this.pathIndex.getStats()}createPatches(e){let n=[],t=new Set;for(let i of e){let r=i.path.join("."),s=!1;for(let o of t)if(r.startsWith(o+".")){s=!0;break}if(s)continue;let a=this.createPatch(i);n.push(a),t.add(r),i.type==="replace"&&typeof i.value=="object"&&t.add(r)}return n}createPatch(e){return{type:e.type,path:e.path,value:e.value,oldValue:e.oldValue,priority:this.calculatePriority(e),signal:this.pathIndex.get(e.path)}}calculatePriority(e){let n=0;return n+=(10-e.path.length)*10,e.path.some(t=>typeof t=="number")&&(n-=20),e.type==="replace"&&(n+=30),n}sortPatches(e){return e.sort((n,t)=>n.priority!==t.priority?t.priority-n.priority:n.path.length-t.path.length)}applyPatches(e,n){let t=[],i=0;for(let r of n)this.applyPatch(r,e)&&(t.push(r.path.join(".")),i++);return{appliedPaths:t,updateCount:i,batchCount:1}}batchApplyPatches(e,n,t=50){let i=[];for(let a=0;a<n.length;a+=t)i.push(n.slice(a,a+t));let r=[],s=0;for(let a of i)for(let o of a)this.applyPatch(o,e)&&(r.push(o.path.join(".")),s++);return{appliedPaths:r,updateCount:s,batchCount:i.length}}applyPatch(e,n){try{if(e.signal&&g(e.signal)&&"set"in e.signal){let r=e.signal();return this.isEqual(r,e.value)?!1:(e.signal.set(e.value),e.type==="add"&&e.value!==void 0&&this.pathIndex.set(e.path,e.signal),!0)}let t=n;for(let r=0;r<e.path.length-1;r++){let s=e.path[r];if(t=t[s],!t||typeof t!="object")return!1}let i=e.path[e.path.length-1];return this.isEqual(t[i],e.value)?!1:(t[i]=e.value,!0)}catch(t){return console.error(`Failed to apply patch at ${e.path.join(".")}:`,t),!1}}isEqual(e,n){if(e===n)return!0;if(typeof e!=typeof n||e===null||n===null||typeof e!="object")return!1;let t=e,i=n;if(Array.isArray(t)&&Array.isArray(i)){if(t.length!==i.length)return!1;for(let a=0;a<t.length;a++)if(t[a]!==i[a])return!1;return!0}let r=Object.keys(t),s=Object.keys(i);if(r.length!==s.length)return!1;for(let a=0;a<r.length;a++){let o=r[a];if(!(o in i)||t[o]!==i[o])return!1}try{return JSON.stringify(e)===JSON.stringify(n)}catch{return!1}}};function S(){return d=>{let e=null,n=null,t=d,i=d;return i.updateOptimized=(r,s)=>{n||(e=new m,e.buildFromTree(t.state),n=new T(t.state));let a=n.update(t.state,r,s);return a.changed&&e&&(a.changedPaths.length?e.incrementalUpdate(t.state,a.changedPaths):(e.clear(),e.buildFromTree(t.state))),a},i.getPathIndex=()=>e,i}}var H=Object.assign(S,{});export{S as a};
