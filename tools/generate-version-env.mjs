// Generates a version constants file for the demo app so the UI
// always reflects the current package versions without manual edits.
// Converted to CommonJS for compatibility with various Node invocations.
const fs = require('node:fs');
const path = require('node:path');

const workspaceRoot = path.resolve(process.cwd());
const corePkgPath = path.join(
  workspaceRoot,
  'packages',
  'core',
  'package.json'
);
const enterprisePkgPath = path.join(
  workspaceRoot,
  'packages',
  'enterprise',
  'package.json'
);
const targetPath = path.join(
  workspaceRoot,
  'apps',
  'demo',
  'src',
  'app',
  'version.ts'
);

function readVersion(p) {
  try {
    const json = JSON.parse(fs.readFileSync(p, 'utf8'));
    return json.version || 'unknown';
  } catch (e) {
    console.error(`Failed to read version from ${p}:`, e);
    return 'unknown';
  }
}

const coreVersion = readVersion(corePkgPath);
const enterpriseVersion = readVersion(enterprisePkgPath);

const contents = `// AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.\n// Generated by tools/generate-version-env.mjs\nexport const SIGNALTREE_CORE_VERSION = '${coreVersion}';\nexport const SIGNALTREE_ENTERPRISE_VERSION = '${enterpriseVersion}';\nexport const SIGNALTREE_VERSION_SUMMARY = '@signaltree/core v${coreVersion} • enterprise v${enterpriseVersion}';\n`;

fs.writeFileSync(targetPath, contents, 'utf8');
console.log(
  `✔ Wrote versions to ${path.relative(
    workspaceRoot,
    targetPath
  )}: core=${coreVersion}, enterprise=${enterpriseVersion}`
);
