#!/usr/bin/env node
// AUTO-GENERATED VERSION CONSTANTS CREATOR
// Reads package versions and writes demo app version.ts
const fs = require('node:fs');
const path = require('node:path');

const workspaceRoot = path.resolve(process.cwd());
const corePkgPath = path.join(
  workspaceRoot,
  'packages',
  'core',
  'package.json'
);
const enterprisePkgPath = path.join(
  workspaceRoot,
  'packages',
  'enterprise',
  'package.json'
);
const targetPath = path.join(
  workspaceRoot,
  'apps',
  'demo',
  'src',
  'app',
  'version.ts'
);

const libraryVersionsTargetPath = path.join(
  workspaceRoot,
  'apps',
  'demo',
  'src',
  'app',
  'library-versions.ts'
);

function readVersion(p) {
  try {
    const json = JSON.parse(fs.readFileSync(p, 'utf8'));
    return json.version || 'unknown';
  } catch (e) {
    console.error(`Failed to read version from ${p}:`, e);
    return 'unknown';
  }
}

function readInstalledPackageVersion(pkgName) {
  try {
    // Resolve from workspace root so pnpm layouts still work.
    const pkgJsonPath = require.resolve(`${pkgName}/package.json`, {
      paths: [workspaceRoot],
    });
    return readVersion(pkgJsonPath);
  } catch (_e) {
    return 'unknown';
  }
}

const coreVersion = readVersion(corePkgPath);
const enterpriseVersion = readVersion(enterprisePkgPath);

const demoLibraryVersions = {
  signaltree: coreVersion,
  'ngrx-store': readInstalledPackageVersion('@ngrx/store'),
  'ngrx-signals': readInstalledPackageVersion('@ngrx/signals'),
  akita: readInstalledPackageVersion('@datorama/akita'),
  elf: readInstalledPackageVersion('@ngneat/elf'),
  ngxs: readInstalledPackageVersion('@ngxs/store'),
};

const contents = `// AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.\n// Generated by tools/generate-version-env.cjs\nexport const SIGNALTREE_CORE_VERSION = '${coreVersion}';\nexport const SIGNALTREE_ENTERPRISE_VERSION = '${enterpriseVersion}';\nexport const SIGNALTREE_VERSION_SUMMARY = '@signaltree/core v${coreVersion} • enterprise v${enterpriseVersion}';\n`;

const libraryVersionsContents = `// AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.\n// Generated by tools/generate-version-env.cjs\nexport const DEMO_LIBRARY_VERSIONS: Record<string, string> = ${JSON.stringify(
  demoLibraryVersions,
  null,
  2
)};\n`;

fs.writeFileSync(targetPath, contents, 'utf8');
fs.writeFileSync(libraryVersionsTargetPath, libraryVersionsContents, 'utf8');
console.log(
  `✔ Wrote versions to ${path.relative(
    workspaceRoot,
    targetPath
  )}: core=${coreVersion}, enterprise=${enterpriseVersion}`
);

console.log(
  `✔ Wrote demo library versions to ${path.relative(
    workspaceRoot,
    libraryVersionsTargetPath
  )}`
);
